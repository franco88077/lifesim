{% extends "layouts/base.html" %}

{% block extra_css %}
  <link rel="stylesheet" href="{{ url_for('job.static', filename='styles/job.css') }}" />
{% endblock %}

{% block extra_js %}
  <script src="{{ url_for('job.static', filename='js/job.js') }}" defer></script>
{% endblock %}

{% block content %}
  <div class="job-shell">
    <section class="job-hero">
      <div class="job-hero__intro">
        <h1>Lifesim — Job</h1>
        <p>Design an efficient job board, enforce payouts, and keep every shift purposeful.</p>
        <div class="job-hero__defaults" role="list">
          <span role="listitem">Minimum hourly wage <strong>${{ job_rules.minimum_wage }}</strong></span>
          <span role="listitem">Minimum task pay <strong>${{ job_rules.minimum_fixed_pay }}</strong></span>
          <span role="listitem">Daily completion cap <strong>{{ job_rules.daily_completion_limit }}×</strong></span>
        </div>
      </div>
      <div class="job-hero__stats" role="list">
        {% for metric in job_metrics %}
          <article class="hero-stat" role="listitem">
            <span class="hero-stat__label">{{ metric.title }}</span>
            <strong>{{ metric.value }}</strong>
            <p>{{ metric.support }}</p>
          </article>
        {% endfor %}
      </div>
    </section>

    <section class="job-subnav" aria-label="Job navigation">
      <nav class="job-tabs">
        <a
          href="#job-add"
          class="job-tab is-active"
          data-job-tab="add"
          aria-current="page"
        >
          Add Job
        </a>
        <a href="#job-manage" class="job-tab" data-job-tab="manage">Manage Jobs</a>
        <a href="#job-settings" class="job-tab" data-job-tab="settings">Job Settings</a>
      </nav>
    </section>

    <div class="job-panels">
      <section
        class="job-panel is-active"
        id="job-add"
        data-job-panel="add"
        aria-label="Add job"
      >
        <header class="job-panel__header">
          <h2>Available opportunities</h2>
          <p>Choose new work that fits your schedule and keeps your income diversified.</p>
        </header>
        <div class="job-list" role="list">
          {% for job in job_catalog %}
            <article class="job-card" data-job="{{ job.id }}" role="listitem">
              <header class="job-card__header">
                <h3>{{ job.title }}</h3>
                <p class="job-card__meta">{{ job.type }}</p>
              </header>
              <p class="job-card__description">{{ job.description }}</p>
              <div class="job-card__details">
                <span class="job-card__rate">{{ job.rate }}</span>
                <div class="job-card__skills" aria-label="Key skills">
                  {% for skill in job.skills %}
                    <span class="job-card__skill">{{ skill }}</span>
                  {% endfor %}
                </div>
              </div>
              <footer class="job-card__footer">
                <button type="button" class="job-card__cta" data-log-action="select-job">
                  Select job
                </button>
                <button type="button" class="job-card__cta job-card__cta--secondary" data-log-action="save-job">
                  Save for later
                </button>
              </footer>
            </article>
          {% endfor %}
        </div>
      </section>

      <section
        class="job-panel"
        id="job-manage"
        data-job-panel="manage"
        aria-label="Manage jobs"
        hidden
      >
        <header class="job-panel__header">
          <h2>Manage jobs</h2>
          <p>Build repeatable gigs, lock in minimum pay, and keep daily streaks intact.</p>
        </header>
        <div class="job-manage__summary" role="list">
          <article class="job-summary" role="listitem">
            <span class="job-summary__label">Hourly guardrail</span>
            <strong>${{ job_rules.minimum_wage }}</strong>
            <p>Minimum hourly wage for per-hour jobs</p>
          </article>
          <article class="job-summary" role="listitem">
            <span class="job-summary__label">Task guardrail</span>
            <strong>${{ job_rules.minimum_fixed_pay }}</strong>
            <p>Minimum payout for per-task jobs</p>
          </article>
          <article class="job-summary" role="listitem">
            <span class="job-summary__label">Daily repetition</span>
            <strong>{{ job_rules.daily_completion_limit }}×</strong>
            <p>Maximum completions per job each day</p>
          </article>
        </div>

        <div class="job-manage__grid">
          <section class="job-builder" aria-label="Create a job template">
            <header class="job-builder__header">
              <h3>Build a new job</h3>
              <p>Define the pay structure, category, and repetition guardrails before publishing.</p>
            </header>
            <form class="job-builder__form" action="#" method="post">
              <div class="job-builder__field">
                <label for="job-name">Job title</label>
                <input
                  type="text"
                  id="job-name"
                  name="title"
                  placeholder="e.g., Weekend laundry reset"
                  required
                />
              </div>

              <fieldset class="job-builder__field job-builder__field--inline">
                <legend>Pay type</legend>
                <label class="job-chip">
                  <input type="radio" name="pay_type" value="hourly" checked />
                  <span>Pay per hour</span>
                </label>
                <label class="job-chip">
                  <input type="radio" name="pay_type" value="task" />
                  <span>Pay per task</span>
                </label>
              </fieldset>

              <div class="job-builder__field-group">
                <div class="job-builder__field" data-pay-field="hourly">
                  <label for="job-hourly-rate">Hourly rate</label>
                  <input
                    type="number"
                    id="job-hourly-rate"
                    name="hourly_rate"
                    min="{{ job_rules.minimum_wage }}"
                    value="{{ job_rules.minimum_wage }}"
                    data-minimum="{{ job_rules.minimum_wage }}"
                  />
                </div>
                <div class="job-builder__field" data-pay-field="task" hidden>
                  <label for="job-task-rate">Task payout</label>
                  <input
                    type="number"
                    id="job-task-rate"
                    name="task_rate"
                    min="{{ job_rules.minimum_fixed_pay }}"
                    value="{{ job_rules.minimum_fixed_pay }}"
                    data-minimum="{{ job_rules.minimum_fixed_pay }}"
                  />
                </div>
                <div class="job-builder__field">
                  <label for="job-daily-limit">Daily completion limit</label>
                  <input
                    type="number"
                    id="job-daily-limit"
                    name="daily_limit"
                    min="1"
                    value="{{ job_rules.daily_completion_limit }}"
                    data-daily-limit="{{ job_rules.daily_completion_limit }}"
                  />
                </div>
              </div>

              <div class="job-builder__field">
                <span class="job-builder__label">Categories</span>
                <div class="job-builder__chips">
                  {% for category in job_categories %}
                    <label class="job-chip">
                      <input type="checkbox" name="categories" value="{{ category.id }}" />
                      <span>{{ category.label }}</span>
                    </label>
                  {% endfor %}
                </div>
              </div>

              <div class="job-builder__preview" data-pay-preview>
                Set a rate to preview projected earnings and guardrail checks.
              </div>

              <div class="job-builder__actions">
                <button type="submit" class="job-builder__submit">Add to board</button>
                <button type="button" class="job-builder__secondary">Save as draft</button>
              </div>
            </form>
          </section>

          <section class="job-ledger" aria-label="Managed jobs">
            <header class="job-ledger__header">
              <h3>Today's board</h3>
              <p>Log completions to stay within the daily caps and pay expectations.</p>
            </header>
            <div class="job-ledger__table-wrapper">
              <table class="job-ledger__table">
                <thead>
                  <tr>
                    <th scope="col">Job</th>
                    <th scope="col">Category</th>
                    <th scope="col">Pay</th>
                    <th scope="col">Daily limit</th>
                    <th scope="col">Progress</th>
                    <th scope="col">Status</th>
                    <th scope="col" class="job-ledger__actions">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for managed_job in managed_jobs %}
                    <tr
                      data-job-row
                      data-job-title="{{ managed_job.title }}"
                      data-limit="{{ managed_job.daily_limit }}"
                      data-completed="{{ managed_job.completions_today }}"
                    >
                      <th scope="row">
                        <div class="job-ledger__title">
                          <span>{{ managed_job.title }}</span>
                          <span class="job-ledger__meta">{{ managed_job.next_window }}</span>
                        </div>
                      </th>
                      <td>{{ managed_job.category }}</td>
                      <td>
                        <span>{{ managed_job.rate_display }}</span>
                        <span class="job-ledger__frequency">{{ managed_job.frequency_label }}</span>
                        <span class="job-ledger__projection">{{ managed_job.projected_label }}</span>
                      </td>
                      <td>{{ managed_job.daily_limit }}×</td>
                      <td>
                        <div class="job-progress" role="img" aria-label="{{ managed_job.progress_label }}">
                          <span class="job-progress__count">
                            <span data-progress-count>{{ managed_job.completions_today }}</span> / {{ managed_job.daily_limit }}
                          </span>
                          <span class="job-progress__track">
                            <span
                              class="job-progress__fill"
                              style="width: {{ managed_job.progress }}%;"
                              data-progress-fill
                            ></span>
                          </span>
                        </div>
                      </td>
                      <td>
                        <span class="job-status job-status--{{ managed_job.status_class }}">{{ managed_job.status }}</span>
                      </td>
                      <td class="job-ledger__actions">
                        <button type="button" class="job-ledger__action" data-complete-job>Complete</button>
                        <button type="button" class="job-ledger__action job-ledger__action--secondary">Edit</button>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </section>
        </div>

        <div class="job-manage__secondary">
          <section class="job-categories" aria-label="Category breakdown">
            <header class="job-categories__header">
              <h3>Category mix</h3>
              <p>Watch where your effort clusters so you can diversify earnings.</p>
            </header>
            <div class="job-categories__grid" role="list">
              {% for category in category_totals %}
                <article class="job-category" role="listitem">
                  <h4>{{ category.label }}</h4>
                  <p class="job-category__value">{{ category.value }}</p>
                  <p class="job-category__meta">{{ category.jobs }} jobs · {{ category.effort }}</p>
                </article>
              {% endfor %}
            </div>
          </section>

          <section class="schedule" aria-label="Shift schedule">
            <header>
              <div class="schedule__header">
                <h3>Shifts</h3>
                <div class="schedule__total">
                  <span>Weekly total</span>
                  <span id="weekly-total" class="weekly-total" aria-live="polite"></span>
                </div>
              </div>
              <button type="button" class="hours-toggle">Expand hours</button>
            </header>
            <table class="schedule__table">
              <thead>
                <tr>
                  <th scope="col">Day</th>
                  <th scope="col">Hours</th>
                  <th scope="col">Activity</th>
                </tr>
              </thead>
              <tbody>
                {% for shift in shifts %}
                  <tr data-hours="{{ shift.hours }}">
                    <td data-label="Day">{{ shift.day }}</td>
                    <td data-label="Hours">{{ shift.hours }}</td>
                    <td data-label="Activity">{{ shift.activity }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </section>

          <section class="milestones" aria-label="Career milestones">
            <h3>Milestones</h3>
            <div class="milestones__grid">
              {% for milestone in milestones %}
                <article class="milestone" data-status="{{ milestone.status }}">
                  <h4>{{ milestone.name }}</h4>
                  <p>Deadline: {{ milestone.deadline }}</p>
                  <p>Status: {{ milestone.status }}</p>
                </article>
              {% endfor %}
            </div>
          </section>
        </div>
      </section>

      <section
        class="job-panel"
        id="job-settings"
        data-job-panel="settings"
        aria-label="Job settings"
        hidden
      >
        <header class="job-panel__header">
          <h2>Job settings</h2>
          <p>Fine-tune automation, reminders, and scheduling defaults for your workload.</p>
        </header>
        <form class="job-settings" action="#" method="post">
          <div class="job-settings__grid">
            <div class="job-settings__group">
              <div class="job-settings__text">
                <h3>Automation</h3>
                <p>Automatically add selected roles to your managed roster and balance their hours.</p>
              </div>
              <label class="job-toggle">
                <input type="checkbox" name="auto_assign" {% if job_preferences.auto_assign %}checked{% endif %} />
                <span>Auto-assign selected jobs</span>
              </label>
            </div>

            <div class="job-settings__group">
              <div class="job-settings__text">
                <h3>Pay guardrails</h3>
                <p>Set the minimum payout values every new job proposal must meet.</p>
              </div>
              <div class="job-settings__controls job-settings__controls--stacked">
                <label class="job-settings__control">
                  <span class="job-settings__label">Minimum hourly wage</span>
                  <input type="number" name="minimum_wage" min="1" value="{{ job_rules.minimum_wage }}" />
                </label>
                <label class="job-settings__control">
                  <span class="job-settings__label">Minimum task payout</span>
                  <input type="number" name="minimum_fixed_pay" min="1" value="{{ job_rules.minimum_fixed_pay }}" />
                </label>
              </div>
            </div>

            <div class="job-settings__group">
              <div class="job-settings__text">
                <h3>Default shift length</h3>
                <p>Set the number of hours the planner proposes when you create a new shift.</p>
              </div>
              <label class="job-settings__control">
                <span class="job-settings__label">Hours per shift</span>
                <input
                  type="number"
                  name="default_shift_length"
                  min="1"
                  max="12"
                  value="{{ job_preferences.default_shift_length }}"
                />
              </label>
            </div>

            <div class="job-settings__group">
              <div class="job-settings__text">
                <h3>Weekly capacity</h3>
                <p>Control the total time allocation across all roles so you avoid overbooking.</p>
              </div>
              <label class="job-settings__control">
                <span class="job-settings__label">Maximum hours</span>
                <input
                  type="number"
                  name="max_weekly_hours"
                  min="5"
                  max="80"
                  value="{{ job_preferences.max_weekly_hours }}"
                />
              </label>
            </div>

            <div class="job-settings__group">
              <div class="job-settings__text">
                <h3>Daily completion cap</h3>
                <p>Limit how many times a job can be completed to protect your energy and pricing.</p>
              </div>
              <label class="job-settings__control">
                <span class="job-settings__label">Completions per day</span>
                <input
                  type="number"
                  name="daily_completion_limit"
                  min="1"
                  max="12"
                  value="{{ job_rules.daily_completion_limit }}"
                />
              </label>
            </div>

            <div class="job-settings__group">
              <div class="job-settings__text">
                <h3>Notifications</h3>
                <p>Choose how the system keeps you informed about schedule changes and new roles.</p>
              </div>
              <div class="job-settings__controls">
                <label class="job-toggle">
                  <input type="checkbox" name="notifications[email]" {% if job_preferences.notifications.email %}checked{% endif %} />
                  <span>Email updates</span>
                </label>
                <label class="job-toggle">
                  <input type="checkbox" name="notifications[sms]" {% if job_preferences.notifications.sms %}checked{% endif %} />
                  <span>SMS alerts</span>
                </label>
              </div>
            </div>

            <div class="job-settings__group">
              <div class="job-settings__text">
                <h3>Reminders</h3>
                <p>Decide when the planner nudges you ahead of important milestones or shifts.</p>
              </div>
              <label class="job-settings__control">
                <span class="job-settings__label">Reminder timing</span>
                <select name="reminder_window">
                  {% set reminder_options = ["2 hours before", "1 day before", "2 days before", "1 week before"] %}
                  {% for option in reminder_options %}
                    <option value="{{ option }}" {% if job_preferences.reminder_window == option %}selected{% endif %}>
                      {{ option }}
                    </option>
                  {% endfor %}
                </select>
              </label>
            </div>
          </div>
          <div class="job-settings__actions">
            <button type="submit" class="job-settings__submit">Save preferences</button>
            <button type="button" class="job-settings__reset">Reset to defaults</button>
          </div>
        </form>
      </section>
    </div>
  </div>
{% endblock %}
