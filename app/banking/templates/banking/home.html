{% extends "layouts/base.html" %}

{% block extra_css %}
  <link rel="stylesheet" href="{{ url_for('banking.static', filename='styles/banking.css') }}" />
{% endblock %}

{% block extra_js %}
  <script src="{{ url_for('banking.static', filename='js/banking_home.js') }}" defer></script>
{% endblock %}

{% block content %}
  <div class="banking-shell">
    <section class="banking-subnav" aria-label="Banking navigation">
      <nav class="banking-tabs">
        <a
          href="{{ url_for('banking.home') }}"
          class="banking-tab{% if active_banking_tab == 'home' %} is-active{% endif %}"
          {% if active_banking_tab == 'home' %}aria-current="page"{% endif %}
        >
          Banking Home
        </a>
        <a
          href="{{ url_for('banking.insights') }}"
          class="banking-tab{% if active_banking_tab == 'insights' %} is-active{% endif %}"
          {% if active_banking_tab == 'insights' %}aria-current="page"{% endif %}
        >
          Account Insights
        </a>
        <a
          href="{{ url_for('banking.transfer') }}"
          class="banking-tab{% if active_banking_tab == 'transfer' %} is-active{% endif %}"
          {% if active_banking_tab == 'transfer' %}aria-current="page"{% endif %}
        >
          Banking Transfer
        </a>
        <a
          href="{{ url_for('banking.settings') }}"
          class="banking-tab{% if active_banking_tab == 'settings' %} is-active{% endif %}"
          {% if active_banking_tab == 'settings' %}aria-current="page"{% endif %}
        >
          Banking Settings
        </a>
      </nav>
    </section>

    <section class="banking-overview">
      <header class="banking-overview__header">
        <h1>{{ bank_settings.bank_name }}</h1>
      </header>

      {% if missing_accounts %}
        {% set missing_titles = missing_accounts | map('capitalize') | list %}
        {% set missing_phrase = missing_titles | join(' and ') %}
        <section class="bank-onboarding" aria-label="Bank account onboarding">
          <div class="bank-onboarding__copy">
            {% if not has_open_accounts %}
              <h2>Welcome to {{ bank_settings.bank_name }}</h2>
              <p>
                Open your first checking or savings account with {{ available_cash }} ready in cash to allocate.
              </p>
            {% else %}
              <h2>{{ bank_settings.bank_name }} Account Options</h2>
              <p>
                Your {{ missing_phrase }} account is still closed. Move cash into the bank to unlock more tools.
              </p>
            {% endif %}
          </div>
          <div class="bank-onboarding__actions">
            <button type="button" class="cta" data-open-account>Open Account</button>
          </div>
          <p class="bank-onboarding__footnote">
            Minimum deposits — Checking: {{ account_opening_requirements.checking }}, Savings:
            {{ account_opening_requirements.savings }}
          </p>
        </section>
      {% endif %}

      <section class="account-activity" aria-label="Account activity">
        <div class="account-activity__grid">
          <div class="account-activity__transactions" aria-label="Recent transactions">
            <h3>Recent Transactions</h3>
            {% if recent_transactions %}
              <ul class="transaction-list">
                {% for transaction in recent_transactions %}
                  <li class="transaction-list__item" data-direction="{{ transaction.direction }}">
                    <div class="transaction-list__row">
                      <span class="transaction-list__name">{{ transaction.name }}</span>
                      <span class="transaction-list__amount">{{ transaction.amount_display }}</span>
                    </div>
                    <p class="transaction-list__meta">{{ transaction.account_name }} · {{ transaction.timestamp }}</p>
                    <p class="transaction-list__description">{{ transaction.description }}</p>
                  </li>
                {% endfor %}
              </ul>
              {% if has_more_transactions %}
                <span
                  class="transaction-view-more"
                  role="link"
                  tabindex="0"
                  data-view-more="{{ url_for('banking.transactions') }}"
                >
                  View more
                </span>
              {% endif %}
            {% else %}
              <p class="transaction-list__empty">
                No transactions recorded yet. Transfers will appear here automatically.
              </p>
            {% endif %}
          </div>
          <div class="account-activity__balances" aria-label="Account balances">
            <h3>Account Balances</h3>
            {% if not has_open_accounts %}
              <p class="account-activity__empty">
                No banking accounts are open yet. Use the Open Account action above to get started.
              </p>
            {% endif %}
            <div class="account-grid">
              {% for account in accounts %}
                <article class="account-card" data-account-card data-account="{{ account.id }}">
                  <header>
                    {% if account.type %}
                      <p class="account-card__type">{{ account.type }}</p>
                    {% endif %}
                    <h2>{{ account.name }}</h2>
                  </header>
                  <p class="account-card__balance">
                    <span data-balance-value>{{ account.display_balance }}</span>
                  </p>
                </article>
              {% endfor %}
            </div>
            <section class="account-due" aria-label="Account due summary">
              <h4>Account Due</h4>
              <div class="account-due__grid">
                {% for due in account_due_cards %}
                  <article class="account-due__card">
                    <header>
                      <h5>{{ due.name }}</h5>
                      <span class="account-due__label">Amount Due</span>
                    </header>
                    <p class="account-due__amount">{{ due.amount }}</p>
                    <p class="account-due__note">{{ due.due_date }}</p>
                    <p class="account-due__tip">{{ due.tip }}</p>
                  </article>
                {% endfor %}
              </div>
            </section>
          </div>
        </div>
      </section>
    </section>

    <div class="modal" id="account-opening-modal" role="dialog" aria-modal="true" aria-labelledby="account-opening-title" hidden>
      <div class="modal__dialog">
        <header class="modal__header">
          <h2 id="account-opening-title">Open a Banking Account</h2>
          <button type="button" class="modal__close" data-close-modal aria-label="Close">×</button>
        </header>
        <form id="account-opening-form" class="modal__form">
          <p class="modal__intro">
            Choose which accounts to open and decide how much to deposit from cash. You currently have {{ available_cash }} on hand.
          </p>
          <fieldset class="modal__fieldset">
            <legend>Select Account Types</legend>
            <label class="modal__option">
              <input type="checkbox" value="checking" data-account-option {% if 'checking' not in missing_accounts %}disabled{% endif %} />
              <span class="modal__option-label">
                Checking Account
                <span class="modal__option-note">
                  {% if 'checking' not in missing_accounts %}
                    Already open
                  {% else %}
                    Minimum deposit {{ account_opening_requirements.checking }}
                  {% endif %}
                </span>
              </span>
            </label>
            <div class="modal__deposit" data-deposit-section="checking" hidden>
              <label>
                <span>Deposit amount</span>
                <div class="modal__input">
                  <span class="modal__input-prefix">$</span>
                  <input type="number" step="0.01" min="0" data-deposit-input="checking" />
                </div>
              </label>
            </div>
            <label class="modal__option">
              <input type="checkbox" value="savings" data-account-option {% if 'savings' not in missing_accounts %}disabled{% endif %} />
              <span class="modal__option-label">
                Savings Account
                <span class="modal__option-note">
                  {% if 'savings' not in missing_accounts %}
                    Already open
                  {% else %}
                    Minimum deposit {{ account_opening_requirements.savings }}
                  {% endif %}
                </span>
              </span>
            </label>
            <div class="modal__deposit" data-deposit-section="savings" hidden>
              <label>
                <span>Deposit amount</span>
                <div class="modal__input">
                  <span class="modal__input-prefix">$</span>
                  <input type="number" step="0.01" min="0" data-deposit-input="savings" />
                </div>
              </label>
            </div>
          </fieldset>
          <div class="modal__feedback" data-modal-feedback hidden></div>
          <div class="modal__actions">
            <button type="button" class="cta secondary" data-close-modal>Cancel</button>
            <button type="submit" class="cta" data-submit-button>Open Selected Accounts</button>
          </div>
        </form>
      </div>
    </div>
    <div class="modal-backdrop" data-modal-backdrop hidden></div>

    <script type="application/json" id="account-opening-config">
      {{ {
        "available_cash": available_cash_value,
        "requirements": account_opening_requirements_value,
        "endpoint": url_for('banking.api_open_accounts')
      } | tojson }}
    </script>
  </div>
{% endblock %}
