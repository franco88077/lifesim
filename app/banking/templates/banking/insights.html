{% extends "layouts/base.html" %}

{% block extra_css %}
  <link rel="stylesheet" href="{{ url_for('banking.static', filename='styles/banking.css') }}" />
{% endblock %}

{% block content %}
  <div class="banking-shell">
    <section class="banking-subnav" aria-label="Banking navigation">
      <nav class="banking-tabs">
        <a
          href="{{ url_for('banking.home') }}"
          class="banking-tab{% if active_banking_tab == 'home' %} is-active{% endif %}"
          {% if active_banking_tab == 'home' %}aria-current="page"{% endif %}
        >
          Banking Home
        </a>
        {% if has_bank_accounts %}
          <a
            href="{{ url_for('banking.insights') }}"
            class="banking-tab{% if active_banking_tab == 'insights' %} is-active{% endif %}"
            {% if active_banking_tab == 'insights' %}aria-current="page"{% endif %}
          >
            Account Insights
          </a>
          <a
            href="{{ url_for('banking.transfer') }}"
            class="banking-tab{% if active_banking_tab == 'transfer' %} is-active{% endif %}"
            {% if active_banking_tab == 'transfer' %}aria-current="page"{% endif %}
          >
            Banking Transfer
          </a>
        {% endif %}
        <a
          href="{{ url_for('banking.settings') }}"
          class="banking-tab{% if active_banking_tab == 'settings' %} is-active{% endif %}"
          {% if active_banking_tab == 'settings' %}aria-current="page"{% endif %}
        >
          Banking Settings
        </a>
      </nav>
    </section>

    <section class="banking-overview" aria-label="Account insights">
      <header class="banking-overview__header">
        <h1>{{ bank_settings.bank_name }} — Banking Insights</h1>
        <p>
          Review the bank’s fees, interest, and cash posture so every decision reflects your institution’s current
          outlook.
        </p>
      </header>
      {% if has_bank_accounts %}
        <div class="insights-layout">
          {% set available_charts = account_insights.charts | selectattr('is_available') | list %}
          {% if available_charts %}
            {% set default_chart = available_charts[0] %}
            <section class="insight-panel" aria-label="Account performance charts">
              <header class="insight-panel__header">
                <h2>Performance Trends</h2>
                <p>
                  Compare balances and savings growth with instant views by day, month, or year.
                </p>
              </header>
              <div class="insight-chart" data-insight-chart>
                <div class="insight-chart__controls">
                  <label class="insight-chart__focus" for="insight-chart-focus">
                    Chart focus
                    <select id="insight-chart-focus" data-chart-focus>
                      {% for chart in account_insights.charts %}
                        <option
                          value="{{ chart.slug }}"
                          {% if not chart.is_available %}disabled{% endif %}
                          {% if chart.slug == default_chart.slug %}selected{% endif %}
                        >
                          {{ chart.name }}
                        </option>
                      {% endfor %}
                    </select>
                  </label>
                  <div class="insight-chart__ranges" role="group" aria-label="Timeframe selection">
                    <button type="button" data-chart-range="daily" aria-pressed="true">Per Day</button>
                    <button type="button" data-chart-range="monthly" aria-pressed="false">Per Month</button>
                    <button type="button" data-chart-range="yearly" aria-pressed="false">Per Year</button>
                  </div>
                </div>
                <div class="insight-chart__summary">
                  <p class="insight-chart__description" data-chart-description>{{ default_chart.description }}</p>
                  <p class="insight-chart__value" data-chart-value aria-live="polite">—</p>
                </div>
                <div class="insight-chart__canvas">
                  <canvas id="insight-chart-canvas" role="img" aria-label="Account performance chart"></canvas>
                  <p class="insight-chart__empty" data-chart-empty hidden>Data is not available for this selection yet.</p>
                </div>
              </div>
              <script type="application/json" id="insight-chart-data">
                {{ account_insights.charts | tojson }}
              </script>
            </section>
          {% endif %}
          {% if insight_accounts %}
            <section class="insight-panel" aria-label="Anchor dates">
              <header class="insight-panel__header">
                <h2>Anchor Timelines</h2>
                <p>See when each account started, when reviews occur, and what balances keep fees away.</p>
              </header>
              <div class="insight-panel__grid">
                {% for insight in insight_accounts %}
                  <article class="summary-card">
                    <header class="summary-card__header">
                      <h3>{{ insight.name }}</h3>
                      <span class="insight-status insight-status--open">Open</span>
                    </header>
                    <dl class="summary-card__details">
                      <div>
                        <dt>Account opened</dt>
                        <dd>{{ insight.opened }}</dd>
                      </div>
                      <div>
                        <dt>Next anchor date</dt>
                        <dd>{{ insight.next_anchor }}</dd>
                      </div>
                      <div>
                        <dt>Minimum balance</dt>
                        <dd>{{ insight.minimum_balance }}</dd>
                      </div>
                      <div>
                        <dt>Fee if below</dt>
                        <dd>{{ insight.fee }}</dd>
                      </div>
                    </dl>
                  </article>
                {% endfor %}
              </div>
            </section>
          {% endif %}

          {% if insight_due_items %}
            <section class="insight-panel" aria-label="Due date guidance">
              <header class="insight-panel__header">
                <h2>Due Date Guidance</h2>
                <p>Review how to avoid service charges and keep each account compliant ahead of the anchor date.</p>
              </header>
              <div class="insight-due-grid">
                {% for due in insight_due_items %}
                  <article class="insight-due-card summary-card">
                    <header>
                      <h3>{{ due.name }}</h3>
                      <span class="insight-due-label">Amount Due</span>
                    </header>
                    <p class="insight-due-amount">{{ due.amount }}</p>
                    <p class="insight-due-date">{{ due.due_date }}</p>
                    <p class="insight-due-tip">{{ due.tip }}</p>
                  </article>
                {% endfor %}
              </div>
            </section>
          {% endif %}

          {% if has_savings_account %}
            <section class="insight-panel" aria-label="Savings interest outlook">
              <header class="insight-panel__header">
                <h2>Interest Outlook</h2>
                <p>
                  Understand how {{ account_insights.savings.apy_rate }} grows your savings and when the next payout is expected.
                </p>
              </header>
              <div class="insight-apy summary-card">
                <p class="insight-apy__headline">
                  Maintain the current balance to earn <strong>{{ account_insights.savings.projected_interest }}</strong>
                  on {{ account_insights.savings.next_anchor }}.
                </p>
                <p class="insight-apy__note">
                  Interest posts on the anchor date and compounds automatically. Deposits before that day increase the payout.
                </p>
              </div>
            </section>
          {% endif %}
        </div>
      {% else %}
        <p class="insight-empty">Open a checking or savings account to unlock tailored banking insights.</p>
      {% endif %}
    </section>
  </div>
{% endblock %}

{% block extra_js %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js" defer></script>
  <script src="{{ url_for('banking.static', filename='js/banking_insights.js') }}" defer></script>
{% endblock %}
